{
  "test_suite_name": "seek_to",
  "tag": "smoke",
  "test_suite_config":{
    "setup": {
      "statements": [
        {"client":"python", "query_type": "table","wait":1, "query":"drop stream if exists seek_to_stream"},
        {"client":"python", "query_type": "table", "wait":2, "query":"create stream if not exists seek_to_stream(i int, s string, t datetime64(3, 'UTC')) settings event_time_column='t'"},
        {"client":"python", "query_type": "table","depends_on_stream":"seek_to_stream", "wait":1, "query": "insert into seek_to_stream(i, s, t) values (1, 's1', '2022-12-01 00:00:01.111')"},
        {"client":"python", "query_type": "table", "wait":1, "query": "insert into seek_to_stream(i, s, t) values (2, 's2', '2022-12-01 00:00:02.111')"},
        {"client":"python", "query_type": "table", "wait":1, "query": "insert into seek_to_stream(i, s, t) values (3, 's3', '2022-12-01 00:00:03.111')"},
        {"client":"python", "query_type": "table", "wait":1, "query": "insert into seek_to_stream(i, s, t) values (4, 's4', '2022-12-01 00:00:04.111')"}
      ]
    },
    "tests_2_run": {"ids_2_run": ["all"], "tags_2_run":[], "tags_2_skip":{"default":["todo", "to_support", "change", "bug", "sample"],"cluster": ["view", "cluster_table_bug"]}}
  },
  "comments": "Tests covering seek_to by sequence number",
  "tests": [
    {
      "id": 0,
      "tags": ["seek_to"],
      "name": "seek_to",
      "description": "seek to sequene number",
      "steps":[
        {
          "statements": [
            {"client":"python","query_id":"2100", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select i, s from seek_to_stream settings seek_to='0'"},
            {"client":"python","query_id":"2190", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select i, s from seek_to_stream where _tp_sn >= 0"}
          ]
        }
      ],
      "expected_results": [
        {
          "query_id":"2100",
          "expected_results":[
            [1, "s1"], [2, "s2"], [3, "s3"], [4, "s4"]
          ]
        },
        {
          "query_id":"2190",
          "expected_results":[
            [1, "s1"], [2, "s2"], [3, "s3"], [4, "s4"]
          ]
        }
      ]
    },
    {
      "id": 1,
      "tags": ["seek_to"],
      "name": "seek_to",
      "description": "seek to sequene number",
      "steps":[
        {
          "statements": [
            {"client":"python","query_id":"2101", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select i, s from seek_to_stream settings seek_to='1'"},
            {"client":"python","query_id":"2191", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select i, s from seek_to_stream where _tp_sn >= 1"}
          ]
        }
      ],
      "expected_results": [
        {
          "query_id":"2101",
          "expected_results":[
            [2, "s2"], [3, "s3"], [4, "s4"]
          ]
        },
        {
          "query_id":"2191",
          "expected_results":[
            [2, "s2"], [3, "s3"], [4, "s4"]
          ]
        }
      ]
    },
    {
      "id": 2,
      "tags": ["seek_to"],
      "name": "seek_to",
      "description": "seek to sequene number",
      "steps":[
        {
          "statements": [
            {"client":"python","query_id":"2102", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select i, s from seek_to_stream settings seek_to='5'"},
            {"client":"python","query_id":"2192", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select i, s from seek_to_stream where _tp_sn >= 5"}
          ]
        }
      ],
      "expected_results": [
        {
          "query_id":"2102",
          "expected_results":[]
        },
        {
          "query_id":"2192",
          "expected_results":[]
        }
      ]
    },
    {
      "id": 3,
      "tags": ["seek_to"],
      "name": "seek_to",
      "description": "event sequence number predicate",
      "steps":[
        {
          "statements": [
            {"client":"python","query_id":"2100", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select i, s from seek_to_stream where _tp_sn = 1"},
            {"client":"python","query_id":"2101", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select i, s from seek_to_stream where _tp_sn = 5"},
            {"client":"python","query_id":"2102", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select i, s from seek_to_stream where _tp_sn < 2"},
            {"client":"python","query_id":"2103", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select i, s from seek_to_stream where _tp_sn <= 2"},
            {"client":"python","query_id":"2104", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select i, s from seek_to_stream where _tp_sn > 2"},
            {"client":"python","query_id":"2105", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select i, s from seek_to_stream where _tp_sn >= 2"},
            {"client":"python","query_id":"2106", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select i, s from seek_to_stream where _tp_sn != 2"}
          ]
        }
      ],
      "expected_results": [
        {
          "query_id":"2100",
          "expected_results":[
            [2, "s2"]
          ]
        },
        {
          "query_id":"2101",
          "expected_results":[]
        },
        {
          "query_id":"2102",
          "expected_results":[
            [1, "s1"], [2, "s2"]
          ]
        },
        {
          "query_id":"2103",
          "expected_results":[
            [1, "s1"], [2, "s2"], [3, "s3"]
          ]
        },
        {
          "query_id":"2104",
          "expected_results":[
            [4, "s4"]
          ]
        },
        {
          "query_id":"2105",
          "expected_results":[
            [3, "s3"], [4, "s4"]
          ]
        },
        {
          "query_id":"2106",
          "expected_results":[
            [1, "s1"], [2, "s2"], [4, "s4"]
          ]
        }
      ]
    },
    {
      "id": 4,
      "tags": ["seek_to"],
      "name": "seek_to",
      "description": "event time predicate",
      "steps":[
        {
          "statements": [
            {"client":"python","query_id":"2100", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select t, s from seek_to_stream where _tp_time = '2022-12-01 00:00:01.111'"},
            {"client":"python","query_id":"2101", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select t, s from seek_to_stream where _tp_time >= '2022-12-01 00:00:04.112'"},
            {"client":"python","query_id":"2102", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select t, s from seek_to_stream where _tp_time < '2022-12-01 00:00:03.111'"},
            {"client":"python","query_id":"2103", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select t, s from seek_to_stream where _tp_time <= '2022-12-01 00:00:03.111'"},
            {"client":"python","query_id":"2104", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select t, s from seek_to_stream where _tp_time > '2022-12-01 00:00:03.111'"},
            {"client":"python","query_id":"2105", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select t, s from seek_to_stream where _tp_time >= '2022-12-01 00:00:03.111'"},
            {"client":"python","query_id":"2106", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select t, s from seek_to_stream where _tp_time != '2022-12-01 00:00:03.111'"}
          ]
        }
      ],
      "expected_results": [
        {
          "query_id":"2100",
          "expected_results":[
            ["2022-12-01 00:00:01.111000+00:00", "s1"]
          ]
        },
        {
          "query_id":"2101",
          "expected_results":[]
        },
        {
          "query_id":"2102",
          "expected_results":[
            ["2022-12-01 00:00:01.111000+00:00", "s1"], ["2022-12-01 00:00:02.111000+00:00", "s2"]
          ]
        },
        {
          "query_id":"2103",
          "expected_results":[
            ["2022-12-01 00:00:01.111000+00:00", "s1"], ["2022-12-01 00:00:02.111000+00:00", "s2"], ["2022-12-01 00:00:03.111000+00:00", "s3"]
          ]
        },
        {
          "query_id":"2104",
          "expected_results":[
            ["2022-12-01 00:00:04.111000+00:00", "s4"]
          ]
        },
        {
          "query_id":"2105",
          "expected_results":[
            ["2022-12-01 00:00:03.111000+00:00", "s3"], ["2022-12-01 00:00:04.111000+00:00", "s4"]
          ]
        },
        {
          "query_id":"2106",
          "expected_results":[
            ["2022-12-01 00:00:01.111000+00:00", "s1"], ["2022-12-01 00:00:02.111000+00:00", "s2"], ["2022-12-01 00:00:04.111000+00:00", "s4"]
          ]
        }
      ]
    },
    {
      "id": 5,
      "tags": ["seek_to", "todo"],
      "name": "seek_to",
      "description": "event predicate with subquery",
      "steps":[
        {
          "statements": [
            {"client":"python","query_id":"2100", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select t, s from (select * from seek_to_stream) where _tp_time = '2022-12-01 00:00:01.111'"},
            {"client":"python","query_id":"2101", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select t, s from (select *, _tp_sn from seek_to_stream) where _tp_sn = 0"}
          ]
        }
      ],
      "expected_results": [
        {
          "query_id":"2100",
          "expected_results":[
            ["2022-12-01 00:00:01.111000+00:00", "s1"]
          ]
        },
        {
          "query_id":"2101",
          "expected_results":[
            ["2022-12-01 00:00:01.111000+00:00", "s1"]
          ]
        }
      ]
    },
    {
      "id": 6,
      "tags": ["seek_to", "todo"],
      "name": "seek_to",
      "description": "event time predicate with cte",
      "steps":[
        {
          "statements": [
            {"client":"python","query_id":"2100", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"with cte as (select i, s, _tp_time as event_time from seek_to_stream) select i, s from cte where event_time >= '2022-12-01 00:00:01.111'"},
            {"client":"python","query_id":"2101", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"with cte as (select i, s, _tp_sn as sn from seek_to_stream) select i, s from cte where sn >= 0"}
          ]
        }
      ],
      "expected_results": [
        {
          "query_id":"2100",
          "expected_results":[
            [1, "s1"], [2, "s2"], [3, "s3"], [4, "s4"]
          ]
        },
        {
          "query_id":"2101",
          "expected_results":[
            [1, "s1"], [2, "s2"], [3, "s3"], [4, "s4"]
          ]
        }
      ]
    },
    {
      "id": 7,
      "tags": ["seek_to", "todo"],
      "name": "seek_to",
      "description": "event time predicates for multiple streams in join query",
      "steps":[
        {
          "statements": [
            {"client":"python", "wait":1, "query_type": "table", "query":"drop stream if exists seek_to_stream_2"},
            {"client":"python", "wait":2, "query_type": "table", "query":"create stream if not exists seek_to_stream_2(i int, s string, t datetime64(3, 'UTC')) settings event_time_column='t'"},
            {"client":"python", "wait":2, "depends_on_stream":"seek_to_stream_2", "query_type": "table", "query":"insert into seek_to_stream_2(i, s, t) values (1, 's1', '2022-12-01 00:00:01.111')"},
            {"client":"python", "depends_on_stream":"seek_to_stream_2", "query_type": "table", "query":"insert into seek_to_stream_2(i, s, t) values (1, 's1', '2022-12-01 00:00:02.111')"},
            {"client":"python", "depends_on_stream":"seek_to_stream_2", "query_type": "table", "query":"insert into seek_to_stream_2(i, s, t) values (2, 's2', '2022-12-01 00:00:03.111')"},
            {"client":"python", "depends_on_stream":"seek_to_stream_2", "query_type": "table", "query":"insert into seek_to_stream_2(i, s, t) values (2, 's2', '2022-12-01 00:00:04.111')"},
            {"client":"python","query_id":"2100", "depends_on_stream":"seek_to_stream","query_end_timer":2, "query_type": "stream", "query":"select a.i, count() from seek_to_stream as a join seek_to_stream as b on a.i = b.i where a._tp_time >= '2022-12-01 00:00:01.111' and b._tp_time >= '2022-12-01 00:00:02.111' group by a.i"}
          ]
        }
      ],
      "expected_results": [
        {
          "query_id":"2100",
          "expected_results":[
            [1, "s1"], [2, "s2"], [3, "s3"], [4, "s4"]
          ]
        }
      ]
    },
    {
      "id": 8,
      "tags": ["seek_to"],
      "name": "seek_to",
      "description": "event predicate in materialized view",
      "steps":[
        {
          "statements": [
            {"client":"python", "wait":1, "query_type": "table", "query":"drop view if exists seek_to_mv"},
            {"client":"python", "wait":2, "query_type": "table", "query":"create materialized view seek_to_mv as (select window_start as win_start, window_end as win_end, sum(i) as cnt from tumble(seek_to_stream, 2s) where _tp_time >= '2022-12-01 00:00:01.111' group by window_start, window_end)"},
            {"client":"python","depends_on_stream":"seek_to_mv", "wait":5, "query_type": "table", "query_id":"2100", "query":"select win_start, win_end, cnt from table(seek_to_mv)"}
          ]
        }
      ],
      "expected_results": [
        {
          "query_id":"2100",
          "expected_results":[
            ["2022-12-01 00:00:00+00:00", "2022-12-01 00:00:02+00:00", 1],
            ["2022-12-01 00:00:02+00:00", "2022-12-01 00:00:04+00:00", 5]
          ]
        }
      ]
    }
  ]
}
