{
    "test_suite_name": "mv",
    "comments":
        "Test suite covering the materialized view with target stream smoke cases.",
    "test_suite_config": {
        "tests_2_run": {"ids_2_run": ["all"], "tags_2_run":[], "tags_2_skip":{"default":["todo", "to_support", "change", "bug"]}}
    },
    "tests": [
        {
            "id": 0,
            "tags": ["materialized view with target stream"],
            "name": "mv_with_target_stream",
            "description": "create a materialized view with target stream",
            "steps":[
                {"statements": [
                    {"client":"python", "query_type": "table","wait":2,"query":"drop view if exists mv_with_target_stream"},
                    {"client":"python", "query_type": "table","wait":2,"query":"drop stream if exists source_mv_stream"},
                    {"client":"python", "query_type": "table","wait":2, "query":"drop stream if exists target_mv_stream"},
                    {"client":"python", "query_type": "table","wait":2, "query":"create stream if not exists source_mv_stream (i int) settings distributed_flush_threshold_count=1"},
                    {"client":"python", "query_type": "table","wait":2, "query":"create stream if not exists target_mv_stream (ii int) settings distributed_flush_threshold_count=1"},
                    {"client":"python","query_id":"2400", "wait":1, "query_type": "table", "query":"create materialized view mv_with_target_stream into target_mv_stream as select _tp_time, i + 1 as ii from source_mv_stream"},
                    {"client":"python", "query_type": "table","depends_on_stream":"source_mv_stream", "wait":2, "query": "insert into source_mv_stream(i) values (1), (2), (3)"},
                    {"client":"python", "wait":1, "query_id":"2401", "query_type": "table","depends_on_stream":"mv_with_target_stream", "query":"select ii from table(mv_with_target_stream)"},
                    {"client":"python", "wait":1, "query_id":"2402", "query_type": "table","depends_on_stream":"target_mv_stream", "query":"select ii from table(target_mv_stream)"},
                    {"client":"python", "query_type": "table","wait":2,"query":"drop view if exists mv_with_target_stream"},
                    {"client":"python", "query_type": "table","wait":2,"query":"drop stream if exists source_mv_stream"},
                    {"client":"python", "query_type": "table","wait":2, "query":"drop stream if exists target_mv_stream"}
                  ]
                }
            ],
            "expected_results": [
                {"query_id":"2401", "expected_results":[[2], [3], [4]]},
                {"query_id":"2402", "expected_results":[[2], [3], [4]]}
            ]
        },
        {
            "id": 1,
            "tags": ["materialized view with target stream"],
            "name": "multi_mv_with_same_target_stream",
            "description": "create 2 materialized views with same target stream",
            "steps":[
                {"statements": [
                    {"client":"python", "query_type": "table","wait":2, "query":"drop view if exists mv_with_target_stream_1"},
                    {"client":"python", "query_type": "table","wait":2, "query":"drop view if exists mv_with_target_stream_2"},
                    {"client":"python", "query_type": "table","wait":2, "query":"drop stream if exists source_mv_stream"},
                    {"client":"python", "query_type": "table","wait":2, "query":"drop stream if exists target_mv_stream"},
                    {"client":"python", "query_type": "table","wait":2, "query":"create stream if not exists source_mv_stream (i int) settings distributed_flush_threshold_count=1"},
                    {"client":"python", "query_type": "table","wait":2, "query":"create stream if not exists target_mv_stream (ii int) settings distributed_flush_threshold_count=1"},
                    {"client":"python","query_id":"2403", "wait":1, "query_type": "table", "query":"create materialized view mv_with_target_stream_1 into target_mv_stream as select _tp_time, i + 1 as ii from source_mv_stream"},
                    {"client":"python","query_id":"2404", "wait":1, "query_type": "table", "query":"create materialized view mv_with_target_stream_2 into target_mv_stream as select _tp_time, i + 10 as ii from source_mv_stream"},
                    {"client":"python", "query_type": "table","depends_on_stream":"source_mv_stream", "wait":3, "query": "insert into source_mv_stream(i) values (1), (2), (3)"},
                    {"client":"python", "wait":3, "query_id":"2405", "query_type": "table","depends_on_stream":"mv_with_target_stream_1", "query":"select ii from table(mv_with_target_stream_1) ORDER BY ii ASC"},
                    {"client":"python", "wait":1, "query_id":"2406", "query_type": "table","depends_on_stream":"mv_with_target_stream_2", "query":"select ii from table(mv_with_target_stream_2) ORDER BY ii ASC"},
                    {"client":"python", "wait":1, "query_id":"2407", "query_type": "table","depends_on_stream":"target_mv_stream", "query":"select ii from table(target_mv_stream) ORDER BY ii ASC"},
                    {"client":"python", "query_type": "table","wait":2, "query":"drop view if exists mv_with_target_stream_1"},
                    {"client":"python", "query_type": "table","wait":2, "query":"drop view if exists mv_with_target_stream_2"},
                    {"client":"python", "query_type": "table","wait":2, "query":"drop stream if exists source_mv_stream"},
                    {"client":"python", "query_type": "table","wait":2, "query":"drop stream if exists target_mv_stream"}
                ]
                }
            ],
            "expected_results": [
                {"query_id":"2405", "expected_results":[[2], [3], [4], [11], [12], [13]]},
                {"query_id":"2406", "expected_results":[[2], [3], [4], [11], [12], [13]]},
                {"query_id":"2407", "expected_results":[[2], [3], [4], [11], [12], [13]]}
            ]
        },
        {
            "id": 2,
            "tags": ["materialized view with target stream"],
            "name": "mv_with_target_stream_partial_populate",
            "description": "create a materialized view with target stream and materialize partial columns of target table",
            "steps":[
                {"statements": [
                    {"client":"python", "query_type": "table","wait":2, "query":"drop view if exists mv_with_target_stream"},
                    {"client":"python", "query_type": "table","wait":2, "query":"drop stream if exists source_mv_stream"},
                    {"client":"python", "query_type": "table","wait":2, "query":"drop stream if exists target_mv_stream"},
                    {"client":"python", "query_type": "table","wait":2, "query":"create stream if not exists source_mv_stream (i int) settings distributed_flush_threshold_count=1"},
                    {"client":"python", "query_type": "table","wait":2, "query":"create stream if not exists target_mv_stream (ii int, s string) settings distributed_flush_threshold_count=1"},
                    {"client":"python","query_id":"2408", "wait":1, "query_type": "table", "query":"create materialized view mv_with_target_stream into target_mv_stream as select _tp_time, i + 1 as ii from source_mv_stream"},
                    {"client":"python", "query_type": "table","depends_on_stream":"source_mv_stream", "wait":1, "query": "insert into source_mv_stream(i) values (1), (2), (3)"},
                    {"client":"python", "wait":1, "query_id":"2409", "query_type": "table","depends_on_stream":"target_mv_stream", "query":"select ii, s from table(target_mv_stream)"},
                    {"client":"python", "query_type": "table","wait":2, "query":"drop view if exists mv_with_target_stream"},
                    {"client":"python", "query_type": "table","wait":2, "query":"drop stream if exists source_mv_stream"},
                    {"client":"python", "query_type": "table","wait":2, "query":"drop stream if exists target_mv_stream"}
                  ]
                }
            ],
            "expected_results": [
                {"query_id":"2409", "expected_results":[[2, ""], [3, ""], [4, ""]]}
            ]
        },
        {
            "id": 3,
            "tags": ["materialized view"],
            "name": "altering_mv",
            "description": "altering materialied view retention policy",
            "steps":[
                {"statements": [
                    {"client":"python", "query_type": "table","wait":2, "query":"drop view if exists mv_with_inner_stream"},
                    {"client":"python", "query_type": "table","wait":2, "query":"drop view if exists mv_with_target_stream"},
                    {"client":"python", "query_type": "table","wait":2, "query":"drop stream if exists source_mv_stream"},
                    {"client":"python", "query_type": "table","wait":2, "query":"drop stream if exists target_mv_stream"},
                    {"client":"python", "query_type": "table","wait":2, "query":"create stream if not exists source_mv_stream (i int) settings distributed_flush_threshold_count=1"},
                    {"client":"python", "query_type": "table","wait":2, "query":"create stream if not exists target_mv_stream (ii int, s string) settings distributed_flush_threshold_count=1"},
                    {"client":"python", "wait":2, "query_type": "table", "query":"create materialized view mv_with_inner_stream as select _tp_time, i + 1 as ii from source_mv_stream"},
                    {"client":"python", "wait":2, "query_type": "table", "query":"create materialized view mv_with_target_stream into target_mv_stream as select _tp_time, i + 1 as ii from source_mv_stream"},
                    {"client":"python", "wait":1, "query_id":"2400", "query_type": "table","depends_on_stream":"mv_with_inner_stream", "query":"alter stream mv_with_inner_stream modify setting logstore_retention_bytes=1000000"},
                    {"client":"python", "wait":1, "query_id":"2401", "query_type": "table","depends_on_stream":"mv_with_target_stream", "query":"alter stream mv_with_target_stream modify setting logstore_retention_bytes=1000000"},
                    {"client":"python", "wait":1, "query_id":"2402", "query_type": "table","depends_on_stream":"mv_with_inner_stream", "query":"alter stream mv_with_inner_stream modify ttl now()-1d"},
                    {"client":"python", "query_type": "table","wait":2, "query":"drop view if exists mv_with_inner_stream"},
                    {"client":"python", "query_type": "table","wait":2, "query":"drop view if exists mv_with_target_stream"},
                    {"client":"python", "query_type": "table","wait":2, "query":"drop stream if exists source_mv_stream"},
                    {"client":"python", "query_type": "table","wait":2, "query":"drop stream if exists target_mv_stream"}
                  ]
                }
            ],
            "expected_results": [
                {"query_id":"2400", "expected_results":[]},
                {"query_id":"2401", "expected_results":"error_code:48"},
                {"query_id":"2402", "expected_results":[]}
            ]
        }
    ]
}
