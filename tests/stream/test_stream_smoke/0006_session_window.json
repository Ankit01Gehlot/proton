{
    "test_suite_name": "session",
    "tag":"smoke",
    "commments":
        "Tests covering session window test cases.",
    "test_suite_config": {
        "table_schemas":[
            {
                "name": "test_session",
                "type": "table",
                "columns": [
                    {
                        "name": "id",
                        "type": "string"
                    },
                    {
                        "name": "location",
                        "type": "string"
                    },
                    {
                        "name": "value",
                        "type": "float32"
                    },
                    {
                        "name": "json",
                        "type": "string"

                    },
                    {
                        "name": "timestamp",
                        "type": "datetime64(3)",
                        "default": "now64(3)"
                    }
                ],
                "event_time_column":"timestamp"
            }

        ],

        "tests_2_run": {"ids_2_run": ["all"], "tags_2_run":[], "tags_2_skip":["todo", "to_support", "change", "bug", "sample"]}
    },

    "tests": [
        {
            "id": 0,
            "tags": ["session window"],
            "name": "stream session window with session_size triggered emit",
            "description": "stream session window with session_size triggered emit, 2s interval with session_size 10s",
            "steps":[
                {"statements": [
                    {"client":"python", "query_id": 701, "query_type": "stream", "terminate":"auto", "query_end_timer": 1, "query":"select max(value), window_start, window_end, __tp_session_id, id from session(test_session, timestamp, 2s, id) group by __tp_session_id, window_start, window_end, id"}
                ]},
                {"inputs": [
                    {"table_name":"test_session","depends_on":"701", "wait":2, "data": [
                        ["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:00+00:00"],
                        ["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:00+00:00"]
                    ]},

                    {"table_name":"test_session", "data": [["dev1", "ca", 66, "\"create_time\":\"2021-11-02 20:00:02\"", "2020-02-02 20:00:02+00:00"]]}
                    ,
                    {"table_name":"test_session", "data": [["dev4", "ca", 67, "\"create_time\":\"2021-11-02 20:00:11\"", "2020-02-02 20:00:15+00:00"]]}
                ]
                }
            ],
            "expected_results": [{"query_id" : 701, "expected_results":
                [
                    ["58.3", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:01+00:00", "341031629", "dev2"],
                    ["66", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:02+00:00", "1500306067","dev1"]
                ]}
            ]
        },

        {
            "id": 1,
            "tags": ["session window"],
            "name": "stream session window with session_size triggered emit",
            "description": "stream session window with session_size triggered emit, 2s interval with session_size 10s",
            "steps":[
                {"statements": [
                    {"client":"python", "query_id": 701, "query_type": "stream", "terminate":"auto", "query_end_timer": 1, "query":"select max(value), window_start, window_end, __tp_session_id, id from session(test_session, timestamp, 2s, id) group by __tp_session_id, window_start, window_end, id"}
                ]},
                {"inputs": [
                    {"table_name":"test_session","depends_on":"701", "wait":2, "data": [
                        ["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:00+00:00"],
                        ["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:00+00:00"],
                        ["dev1", "ca", 66, "\"create_time\":\"2021-11-02 20:00:02\"", "2020-02-02 20:00:02+00:00"],
                        ["dev2", "ca", 67, "\"create_time\":\"2021-11-02 20:00:11\"", "2020-02-02 20:00:15+00:00"]
                    ]}
                ]
                }
            ],
            "expected_results": [{"query_id" : 701, "expected_results":
                [
                    ["58.3", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:01+00:00", "341031629", "dev2"],
                    ["66", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:02+00:00", "1500306067","dev1"]
                ]}
            ]
        },
        
        {
            "id": 2,
            "tags": ["session window"],
            "name": "stream session window with force timeout",
            "description": "stream session window with force timeout, session window interval 1s, input data with 1s interval continuously and session window emit at 5s",
            "steps":[
                {"statements": [
                    {"client":"python", "query_id": 701, "query_type": "stream", "terminate":"auto", "query_end_timer": 1, "query":"select count(), window_start, window_end, __tp_session_id, id from session(test_session, timestamp, 1s, id) group by __tp_session_id, window_start, window_end, id"}
                ]},
                {"inputs": [
                    {"table_name":"test_session", "depends_on":"701", "wait":2, "data": [["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:00+00:00"]]},
                    {"table_name":"test_session", "data": [["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:00+00:00"]]},
                    {"table_name":"test_session", "data": [["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:01+00:00"]]},
                    {"table_name":"test_session", "data": [["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:01+00:00"]]},
                    {"table_name":"test_session", "data": [["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:02+00:00"]]},
                    {"table_name":"test_session", "data": [["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:02+00:00"]]},
                    {"table_name":"test_session", "data": [["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:03+00:00"]]},
                    {"table_name":"test_session", "data": [["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:03+00:00"]]},
                    {"table_name":"test_session", "data": [["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:04+00:00"]]},
                    {"table_name":"test_session", "data": [["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:04+00:00"]]},
                    {"table_name":"test_session", "data": [["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:05+00:00"]]},
                    {"table_name":"test_session", "data": [["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:05+00:00"]]},
                    {"table_name":"test_session", "data": [["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:06+00:00"]]},
                    {"table_name":"test_session", "data": [["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:06+00:00"]]},
                    {"table_name":"test_session", "data": [["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:07+00:00"]]},
                    {"table_name":"test_session", "data": [["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:07+00:00"]]},
                    {"table_name":"test_session", "data": [["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:08+00:00"]]},
                    {"table_name":"test_session", "data": [["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:08+00:00"]]}
                ]
                }
            ],
            "expected_results": [{"query_id" : 701, "expected_results":
                [
                    ["6", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:05+00:00", "341031629", "dev2"],
                    ["6", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:05+00:00", "1500306067","dev1"]
                ]}
            ]
        },                
        {
            "id": 3,
            "tags": ["session window"],
            "name": "multiple stream session window with multiple emits",
            "description": "3 unique stream session window based id and location, session window interval 1s, input data in 2 batches and 1st batch is emit dur to force timeout threshold is it while 2nd is not emit for not hitting threshold",
            "steps":[
                {"statements": [
                    {"client":"python", "query_id": 701, "query_type": "stream", "terminate":"auto", "query_end_timer": 1, "query":"select count(), window_start, window_end, __tp_session_id, id from session(test_session, timestamp, 1s, id) group by __tp_session_id, window_start, window_end, id"}
                ]},
                {"inputs": [
                    {"table_name":"test_session", "depends_on":"701", "wait":2, "data": [["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:00+00:00"]]},
                    {"table_name":"test_session", "data": [["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:00+00:00"]]},
                    {"table_name":"test_session", "data": [["dev3", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:00+00:00"]]},
                    {"table_name":"test_session", "data": [["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:01+00:00"]]},
                    {"table_name":"test_session", "data": [["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:01+00:00"]]},
                    {"table_name":"test_session", "data": [["dev3", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:01+00:00"]]},
                    {"table_name":"test_session", "data": [["dev4", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:05+00:00"]]},
                    {"table_name":"test_session", "data": [["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:06+00:00"]]},
                    {"table_name":"test_session", "data": [["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:06+00:00"]]},
                    {"table_name":"test_session", "data": [["dev3", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:06+00:00"]]},
                    {"table_name":"test_session", "data": [["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:07+00:00"]]},
                    {"table_name":"test_session", "data": [["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:07+00:00"]]},
                    {"table_name":"test_session", "data": [["dev3", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:07+00:00"]]},
                    {"table_name":"test_session", "data": [["dev4", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:11+00:00"]]}
                ]
                }
            ],
            "expected_results": [{"query_id" : 701, "expected_results":
                [
                    ["2", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:01+00:00", "341031629", "dev2"],
                    ["2", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:01+00:00", "1084008069", "dev3"],
                    ["2", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:01+00:00", "1500306067","dev1"],
                    ["1", "2020-02-02 20:00:05+00:00", "2020-02-02 20:00:06+00:00", "1978072629","dev4"]
                ]}
            ]
        }, 

        {
            "id": 4,
            "tags": ["session window"],
            "name": "multiple stream session window with multiple emits with where clause",
            "description": "3 unique stream session window based id and location, session window interval 1s, input data in 2 batches and triggle 2 batch emits, where clause filter events",
            "steps":[
                {"statements": [
                    {"client":"python", "query_id": 701, "query_type": "stream", "terminate":"auto", "query_end_timer": 3, "query":"select emit_version() as emit_version, count(), window_start, window_end, __tp_session_id, id from session(test_session, timestamp, 1s, id) where id !='dev4' group by __tp_session_id, window_start, window_end, id"}
                ]},
                {"inputs": [
                    {"table_name":"test_session", "depends_on":"701", "wait":2, "data": [["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:00+00:00"]]},
                    {"table_name":"test_session", "data": [["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:00+00:00"]]},
                    {"table_name":"test_session", "data": [["dev3", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:00+00:00"]]},
                    {"table_name":"test_session", "data": [["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:01+00:00"]]},
                    {"table_name":"test_session", "data": [["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:01+00:00"]]},
                    {"table_name":"test_session", "data": [["dev3", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:01+00:00"]]},
                    {"table_name":"test_session", "data": [["dev4", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:05+00:00"]]},
                    {"table_name":"test_session", "data": [["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:02+00:00"]]},
                    {"table_name":"test_session", "data": [["dev3", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:02+00:00"]]},
                    {"table_name":"test_session", "data": [["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:04+00:00"]]},
                    {"table_name":"test_session", "data": [["dev3", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:04+00:00"]]}
                ]
                }
            ],
            "expected_results": [{"query_id" : 701, "expected_results":
                [
                    ["0", "3", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:02+00:00", "341031629", "dev2"],
                    ["1", "3", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:02+00:00", "1084008069", "dev3"]
                ]}
            ]
        },        

        {
            "id": 5,
            "tags": ["session window"],
            "name": "stream session window with timeout interval triggered emit",
            "description": "stream session window with interval triggered emit, 2s interval with session_size 10s",
            "steps":[
                {"statements": [
                    {"client":"python", "query_id": 701, "query_type": "stream", "terminate":"auto", "query_end_timer": 1, "query":"select max(value), window_start, window_end, __tp_session_id, id from session(test_session, timestamp, 2s, id) group by __tp_session_id, window_start, window_end, id"}
                ]},
                {"inputs": [
                    {"table_name":"test_session","depends_on":"701", "wait":2, "data": [
                        ["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:00+00:00"],
                        ["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:01+00:00"]
                    ]},

                    {"table_name":"test_session","data": [
                        ["dev1", "ca", 66, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:01+00:00"],
                        ["dev2", "ca", 60, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:02+00:00"]
                    ]},

                    {"table_name":"test_session", "data": [["dev2", "ca", 67, "\"create_time\":\"2021-11-02 20:00:11\"", "2020-02-02 20:00:05+00:00"]]},

                    {"table_name":"test_session", "data": [["dev1", "ca", 68, "\"create_time\":\"2021-11-02 20:00:11\"", "2020-02-02 20:00:03+00:00"]]},

                    {"table_name":"test_session", "data": [["dev1", "ca", 69, "\"create_time\":\"2021-11-02 20:00:11\"", "2020-02-02 20:00:06+00:00"]]}
                ]
                }
            ],
            "expected_results": [{"query_id" : 701, "expected_results":
            [
                ["60", "2020-02-02 20:00:01+00:00", "2020-02-02 20:00:02+00:00", "341031629", "dev2"],
                ["68", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:03+00:00", "1500306067", "dev1"]
            ]}
            ]
        },
        {
            "id": 6,
            "tags": ["session window"],
            "name": "stream session window with datetime32",
            "description": "stream session window with interval triggered emit, 5s interval with session_size 25s",
            "steps":[
                {"statements": [
                    {"client":"python", "query_id": 701, "query_type": "stream", "terminate":"auto", "query_end_timer": 1, "query":"select max(value), window_start, window_end, __tp_session_id, id from session(test_session, to_start_of_interval(timestamp, 2s), 5s, id) group by __tp_session_id, window_start, window_end, id"}
                ]},
                {"inputs": [
                    {"table_name":"test_session","depends_on":"701", "wait":2, "data": [
                        ["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:00+00:00"],
                        ["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:01+00:00"]
                    ]},

                    {"table_name":"test_session", "data": [
                        ["dev1", "ca", 66, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:01+00:00"],
                        ["dev2", "ca", 60, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:02+00:00"]
                    ]},

                    {"table_name":"test_session", "data": [["dev2", "ca", 67, "\"create_time\":\"2021-11-02 20:00:11\"", "2020-02-02 20:00:08+00:00"]]}
                ]
                }
            ],
            "expected_results": [{"query_id" : 701, "expected_results":
            [
                ["60", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:02+00:00", "341031629", "dev2"]
            ]}
            ]
        },
        {
            "id": 7,
            "tags": ["session window"],
            "name": "stream session window with multiple session keys",
            "description": "stream session window with multiple session keys, triggered by interval, 2s interval with session_size 10",
            "steps":[
                {"statements": [
                    {"client":"python", "query_id": 701, "query_type": "stream", "terminate":"auto", "query_end_timer": 1, "query":"select max(value), window_start, window_end, __tp_session_id, id, location from session(test_session, timestamp, 2s, id, location) group by __tp_session_id, window_start, window_end, id, location"}
                ]},
                {"inputs": [
                    {"table_name":"test_session","depends_on":"701", "wait":2, "data": [
                        ["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:00+00:00"],
                        ["dev2", "bj", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:01+00:00"]
                    ]},

                    {"table_name":"test_session","data": [
                        ["dev1", "ca", 66, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:02+00:00"],
                        ["dev2", "ca", 60, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:02+00:00"]
                    ]},

                    {"table_name":"test_session", "data": [["dev3", "ca", 67, "\"create_time\":\"2021-11-02 20:00:11\"", "2020-02-02 20:00:15+00:00"]]}
                ]
                }
            ],
            "expected_results": [{"query_id" : 701, "expected_results":
            [
                ["66", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:02+00:00", "2746372735", "dev1", "ca"],
                ["60", "2020-02-02 20:00:02+00:00", "2020-02-02 20:00:03+00:00", "4072938192", "dev2", "ca"],
                ["58.3", "2020-02-02 20:00:01+00:00", "2020-02-02 20:00:02+00:00", "4269204367", "dev2", "bj"]
            ]}
            ]
        },
        {
            "id": 8,
            "tags": ["session window"],
            "name": "stream session window with join",
            "description": "stream session window with multiple session keys, triggered by interval, 2s interval with session_size 10, joins with test_session_d",
            "steps":[
                {"statements": [
                    {"client":"python", "query_type": "table", "query":"create stream if not exists test_session_d (id string, type string)"},
                    {"client":"python", "query_type": "table","wait":1, "query":"insert into test_session_d (id, type) values ('dev1', 'roof') ('dev2', 'field') ('dev3', 'window') ('dev4', 'wall') ('dev5', 'roof') ('dev6', 'window') ('dev7', 'wall') ('dev8', 'floor')"},                    
                    {"client":"python", "query_id": 701, "query_type": "stream","wait":2, "terminate":"auto", "query_end_timer": 3, "query":"select max(value), window_start, window_end, __tp_session_id, id, b.type, location from session(test_session, timestamp, 2s, id, location) as a join table(test_session_d) as b on a.id = b.id group by __tp_session_id, window_start, window_end, id, location, b.type"}
                ]},
                {"inputs": [
                    {"table_name":"test_session","depends_on":"701", "wait":2, "data": [
                        ["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:00+00:00"],
                        ["dev2", "bj", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:01+00:00"]
                    ]},

                    {"table_name":"test_session","data": [
                        ["dev1", "ca", 66, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:02+00:00"],
                        ["dev2", "ca", 60, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:02+00:00"]
                    ]},

                    {"table_name":"test_session", "data": [["dev3", "ca", 67, "\"create_time\":\"2021-11-02 20:00:11\"", "2020-02-02 20:00:15+00:00"]]}
                ]
                },
                {"statements": [
                    {"client":"python", "wait": 6, "query_type": "table", "query":"drop stream if exists test_session_d"}
                ]
                }                
            ],
            "expected_results": [{"query_id" : 701, "expected_results":
            [
                ["66", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:02+00:00", "2746372735", "dev1", "roof", "ca"],
                ["60", "2020-02-02 20:00:02+00:00", "2020-02-02 20:00:03+00:00", "4072938192", "dev2","field", "ca"],
                ["58.3", "2020-02-02 20:00:01+00:00", "2020-02-02 20:00:02+00:00", "4269204367", "dev2","field", "bj"]
            ]}
            ]
        }  ,
        {
            "id": 9,
            "tags": ["session window"],
            "name": "stream session window on top of sub query tail",
            "description": "stream session window with multiple session keys, triggered by interval, 2s interval with session_size 10, session based on transformed tail",
            "steps":[
                {"statements": [
                    {"client":"python", "query_id": 701, "query_type": "stream", "terminate":"auto", "query_end_timer": 1, "query":"with transformed as (select id, location, value, to_datetime64(json_extract_string(json, 'create_time'), 3, 'UTC') as transformed_timestamp from test_session) select max(value), window_start, window_end, __tp_session_id, id, location from session(transformed, transformed_timestamp, 2s, id, location) group by __tp_session_id, window_start, window_end, id, location"}
                ]},
                {"inputs": [
                    {"table_name":"test_session","depends_on":"701", "wait":2, "data": [
                        ["dev1", "ca", 57.3, "{\"create_time\":\"2020-02-02 20:00:00\"}", "2020-02-02 20:00:00+00:00"],
                        ["dev2", "bj", 58.3, "{\"create_time\":\"2020-02-02 20:00:01\"}", "2020-02-02 20:00:01+00:00"]
                    ]},

                    {"table_name":"test_session","data": [
                        ["dev1", "ca", 66, "{\"create_time\":\"2020-02-02 20:00:02\"}", "2020-02-02 20:00:02+00:00"],
                        ["dev2", "ca", 60, "{\"create_time\":\"2020-02-02 20:00:02\"}", "2020-02-02 20:00:02+00:00"]
                    ]},

                    {"table_name":"test_session", "data": [["dev3", "ca", 67, "{\"create_time\":\"2020-02-02 20:00:15\"}", "2020-02-02 20:00:15+00:00"]]}
                ]
                }
            ],
            "expected_results": [{"query_id" : 701, "expected_results":
            [
                ["66", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:02+00:00", "2746372735", "dev1", "ca"],
                ["60", "2020-02-02 20:00:02+00:00", "2020-02-02 20:00:03+00:00", "4072938192", "dev2", "ca"],
                ["58.3", "2020-02-02 20:00:01+00:00", "2020-02-02 20:00:02+00:00", "4269204367", "dev2", "bj"]
            ]}
            ]
        },
        {
            "id": 10,
            "tags": ["session window"],
            "name": "stream session window as sub query",
            "description": "stream session window with multiple session keys, triggered by interval, 2s interval with session_size 10, session as subquery",
            "steps":[
                {"statements": [
                    {"client":"python", "query_type": "table", "query":"create stream if not exists test_session_d (id string, type string)"},
                    {"client":"python", "query_type": "table","wait":1, "query":"insert into test_session_d (id, type) values ('dev1', 'roof') ('dev2', 'field') ('dev3', 'window') ('dev4', 'wall') ('dev5', 'roof') ('dev6', 'window') ('dev7', 'wall') ('dev8', 'floor')"},                    
                    {"client":"python", "query_id": 702,"wait":2, "query_type": "stream", "terminate":"auto", "query_end_timer": 3, "query":"with transformed as (select max(value), window_start as s, window_end as e, __tp_session_id, id, b.type, location from session(test_session, timestamp, 2s, id, location) as a join table(test_session_d) as b on a.id = b.id group by __tp_session_id, window_start, window_end, id, location, b.type) select * from transformed"}
                ]},
                {"inputs": [
                    {"table_name":"test_session","depends_on":"702", "wait":1, "data": [
                        ["dev1", "ca", 57.3, "{\"create_time\":\"2020-02-02 20:00:00+00:00\"}", "2020-02-02 20:00:00+00:00"],
                        ["dev2", "bj", 58.3, "{\"create_time\":\"2020-02-02 20:00:01+00:00\"}", "2020-02-02 20:00:01+00:00"]
                    ]},

                    {"table_name":"test_session","data": [
                        ["dev1", "ca", 66, "{\"create_time\":\"2020-02-02 20:00:02+00:00\"}", "2020-02-02 20:00:02+00:00"],
                        ["dev2", "ca", 60, "{\"create_time\":\"2020-02-02 20:00:02+00:00\"}", "2020-02-02 20:00:02+00:00"]
                    ]},

                    {"table_name":"test_session", "data": [["dev3", "ca", 67, "{\"create_time\":\"2020-02-02 20:00:15+00:00\"}", "2020-02-02 20:00:15+00:00"]]}
                ]
                },
                {"statements": [
                    {"client":"python", "wait": 6, "query_type": "table", "query":"drop stream if exists test_session_d"}
                ]
                }      
            ],
            "expected_results": [{"query_id" : 702, "expected_results":
            [
                ["66", "2020-02-02 20:00:00", "2020-02-02 20:00:02", "2746372735", "dev1", "roof", "ca"],
                ["60", "2020-02-02 20:00:02", "2020-02-02 20:00:03", "4072938192", "dev2","field", "ca"],
                ["58.3", "2020-02-02 20:00:01", "2020-02-02 20:00:02", "4269204367", "dev2","field", "bj"]
            ]}
            ]
        },         
        {
            "id": 11,
            "tags": ["session window"],
            "name": "stream session window on top of tumble sub query",
            "description": "stream session window with multiple session keys, triggered by interval, 2s interval with session_size 10, session based on tumble",
            "steps":[
                {"statements": [
                    {"client":"python", "query_id": 701, "query_type": "stream", "terminate":"auto", "query_end_timer": 1, "query":"with transformed as (select id, location, max(value) as max_v, window_start as w_s, window_end as w_e from tumble(test_session, to_datetime64(json_extract_string(json, 'create_time'), 3, 'UTC'), 2s) group by id, location, window_start, window_end) select count(max_v), window_start, window_end, __tp_session_id, id, location from session(transformed, w_e, 2s, id, location) group by __tp_session_id, window_start, window_end, id, location"}
                ]},
                {"inputs": [
                    {"table_name":"test_session","depends_on":"701", "wait":2, "data": [
                        ["dev1", "ca", 57.3, "{\"create_time\":\"2020-02-02 20:00:00\"}", "2020-02-02 20:00:00+00:00"],
                        ["dev2", "bj", 58.3, "{\"create_time\":\"2020-02-02 20:00:01\"}", "2020-02-02 20:00:01+00:00"],
                        ["dev2", "bj", 58.3, "{\"create_time\":\"2020-02-02 20:00:02\"}", "2020-02-02 20:00:02+00:00"]
                    ]},

                    {"table_name":"test_session","depends_on":"701", "data": [
                        ["dev1", "ca", 66, "{\"create_time\":\"2020-02-02 20:00:03\"}", "2020-02-02 20:00:03+00:00"],
                        ["dev2", "ca", 60, "{\"create_time\":\"2020-02-02 20:00:04\"}", "2020-02-02 20:00:04+00:00"]
                    ]},

                    {"table_name":"test_session", "data": [
                        ["dev1", "ca", 67, "{\"create_time\":\"2020-02-02 20:00:15\"}", "2020-02-02 20:00:15+00:00"],
                        ["dev2", "ca", 67, "{\"create_time\":\"2020-02-02 20:00:16\"}", "2020-02-02 20:00:16+00:00"],
                        ["dev3", "ca", 67, "{\"create_time\":\"2020-02-02 20:00:20\"}", "2020-02-02 20:00:20+00:00"]
                    
                    ]}
                ]
                }
            ],
            "expected_results": [{"query_id" : 701, "expected_results":
            [
                ["2", "2020-02-02 20:00:02+00:00", "2020-02-02 20:00:04+00:00", "2746372735", "dev1", "ca"],
                ["2", "2020-02-02 20:00:02+00:00", "2020-02-02 20:00:04+00:00", "4269204367", "dev2", "bj"],
                ["1", "2020-02-02 20:00:06+00:00", "2020-02-02 20:00:07+00:00", "4072938192", "dev2", "ca"]
            ]}
            ]
        }, 
        {
            "id": 12,
            "tags": ["session window", "todo"],
            "name": "stream session window on top of hopping sub query",
            "description": "stream session window with multiple session keys, triggered by interval, 2s interval with session_size 10, session based on hop",
            "steps":[
                {"statements": [
                    {"client":"python", "query_id": 701, "query_type": "stream", "terminate":"auto", "query_end_timer": 1, "query":"with transformed as (select id, location, value, to_datetime64(json_extract_string(json, 'create_time'), 3, 'UTC') as transformed_timestamp from test_session) select max(value), window_start, window_end, __tp_session_id, id, location from session(transformed, transformed_timestamp, 2s, id, location) group by __tp_session_id, window_start, window_end, id, location"}
                ]},
                {"inputs": [
                    {"table_name":"test_session","depends_on":"701", "wait":2, "data": [
                        ["dev1", "ca", 57.3, "{\"create_time\":\"2020-02-02 20:00:00+00:00\"}", "2020-02-02 20:00:00+00:00"],
                        ["dev2", "bj", 58.3, "{\"create_time\":\"2020-02-02 20:00:01+00:00\"}", "2020-02-02 20:00:01+00:00"]
                    ]},

                    {"table_name":"test_session","depends_on":"701", "data": [
                        ["dev1", "ca", 66, "{\"create_time\":\"2020-02-02 20:00:02+00:00\"}", "2020-02-02 20:00:02+00:00"],
                        ["dev2", "ca", 60, "{\"create_time\":\"2020-02-02 20:00:02+00:00\"}", "2020-02-02 20:00:02+00:00"]
                    ]},

                    {"table_name":"test_session", "data": [["dev3", "ca", 67, "{\"create_time\":\"2020-02-02 20:00:15+00:00\"}", "2020-02-02 20:00:15+00:00"]]}
                ]
                }
            ],
            "expected_results": [{"query_id" : 701, "expected_results":
            [
                ["66", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:02+00:00", "2746372735", "dev1", "ca"],
                ["60", "2020-02-02 20:00:02+00:00", "2020-02-02 20:00:03+00:00", "4072938192", "dev2", "ca"],
                ["58.3", "2020-02-02 20:00:01+00:00", "2020-02-02 20:00:02+00:00", "4269204367", "dev2", "bj"]
            ]}
            ]
        },
        {
            "id": 13,
            "tags": ["session window", "todo"],
            "name": "tumble window on top of session window sub query",
            "description": "stream session window with multiple session keys, triggered by interval, 2s interval with session_size 10, tumble based on session",
            "steps":[
                {"statements": [
                    {"client":"python", "query_id": 701, "query_type": "stream", "terminate":"auto", "query_end_timer": 1, "query":"with transformed as (select id, location, value, to_datetime64(json_extract_string(json, 'create_time'), 3, 'UTC') as transformed_timestamp from test_session) select max(value), window_start, window_end, __tp_session_id, id, location from session(transformed, transformed_timestamp, 2s, id, location) group by __tp_session_id, window_start, window_end, id, location"}
                ]},
                {"inputs": [
                    {"table_name":"test_session","depends_on":"701", "wait":2, "data": [
                        ["dev1", "ca", 57.3, "{\"create_time\":\"2020-02-02 20:00:00+00:00\"}", "2020-02-02 20:00:00+00:00"],
                        ["dev2", "bj", 58.3, "{\"create_time\":\"2020-02-02 20:00:01+00:00\"}", "2020-02-02 20:00:01+00:00"]
                    ]},

                    {"table_name":"test_session","depends_on":"701", "data": [
                        ["dev1", "ca", 66, "{\"create_time\":\"2020-02-02 20:00:02+00:00\"}", "2020-02-02 20:00:02+00:00"],
                        ["dev2", "ca", 60, "{\"create_time\":\"2020-02-02 20:00:02+00:00\"}", "2020-02-02 20:00:02+00:00"]
                    ]},

                    {"table_name":"test_session", "data": [["dev3", "ca", 67, "{\"create_time\":\"2020-02-02 20:00:15+00:00\"}", "2020-02-02 20:00:15+00:00"]]}
                ]
                }
            ],
            "expected_results": [{"query_id" : 701, "expected_results":
            [
                ["66", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:02+00:00", "2746372735", "dev1", "ca"],
                ["60", "2020-02-02 20:00:02+00:00", "2020-02-02 20:00:03+00:00", "4072938192", "dev2", "ca"],
                ["58.3", "2020-02-02 20:00:01+00:00", "2020-02-02 20:00:02+00:00", "4269204367", "dev2", "bj"]
            ]}
            ]
        }                                                                                                                 
    ]
}
