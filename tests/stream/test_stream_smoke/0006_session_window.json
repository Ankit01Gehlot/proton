{
    "test_suite_name": "session",
    "tag":"smoke",
    "commments":
        "Tests covering session window test cases.",
    "test_suite_config": {
        "table_schemas":[
            {
                "name": "test_session",
                "type": "table",
                "columns": [
                    {
                        "name": "id",
                        "type": "string"
                    },
                    {
                        "name": "location",
                        "type": "string"
                    },
                    {
                        "name": "value",
                        "type": "float32"
                    },
                    {
                        "name": "json",
                        "type": "string"

                    },
                    {
                        "name": "timestamp",
                        "type": "datetime64(3)",
                        "default": "now64(3)"
                    }
                ],
                "event_time_column":"timestamp"
            }

        ],

        "tests_2_run": {"ids_2_run": ["all"], "tags_2_run":[], "tags_2_skip":["todo", "to_support", "change", "bug", "sample"]}
    },

    "tests": [
        {
            "id": 0,
            "tags": ["session window"],
            "name": "stream session window with session_size triggered emit",
            "description": "stream session window with session_size triggered emit, 2s interval with session_size 10s",
            "steps":[
                {"statements": [
                    {"client":"python", "query_id": 701, "query_type": "stream", "terminate":"auto", "query_end_timer": 1, "query":"select max(value), window_start, window_end, __tp_session_id, id from session(test_session, timestamp, 2s, id) group by __tp_session_id, window_start, window_end, id"}
                ]},
                {"inputs": [
                    {"table_name":"test_session","depends_on":"701", "data": [
                        ["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:00+00:00"],
                        ["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:00+00:00"]
                    ]},

                    {"table_name":"test_session", "data": [["dev1", "ca", 66, "\"create_time\":\"2021-11-02 20:00:02\"", "2020-02-02 20:00:02+00:00"]]}
                    ,
                    {"table_name":"test_session", "data": [["dev2", "ca", 67, "\"create_time\":\"2021-11-02 20:00:11\"", "2020-02-02 20:00:15+00:00"]]}
                ]
                }
            ],
            "expected_results": [{"query_id" : 701, "expected_results":
                [
                    ["58.3", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:00+00:00", "341031629", "dev2"],
                    ["66", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:02+00:00", "1500306067","dev1"]
                ]}
            ]
        },
        {
            "id": 1,
            "tags": ["session window"],
            "name": "stream session window with timeout interval triggered emit",
            "description": "stream session window with interval triggered emit, 2s interval with session_size 10s",
            "steps":[
                {"statements": [
                    {"client":"python", "query_id": 701, "query_type": "stream", "terminate":"auto", "query_end_timer": 1, "query":"select max(value), window_start, window_end, __tp_session_id, id from session(test_session, timestamp, 2s, id) group by __tp_session_id, window_start, window_end, id"}
                ]},
                {"inputs": [
                    {"table_name":"test_session","depends_on":"701", "data": [
                        ["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:00+00:00"],
                        ["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:01+00:00"]
                    ]},

                    {"table_name":"test_session","depends_on":"701", "data": [
                        ["dev1", "ca", 66, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:01+00:00"],
                        ["dev2", "ca", 60, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:02+00:00"]
                    ]},

                    {"table_name":"test_session", "data": [["dev2", "ca", 67, "\"create_time\":\"2021-11-02 20:00:11\"", "2020-02-02 20:00:05+00:00"]]},

                    {"table_name":"test_session", "data": [["dev1", "ca", 68, "\"create_time\":\"2021-11-02 20:00:11\"", "2020-02-02 20:00:03+00:00"]]},

                    {"table_name":"test_session", "data": [["dev1", "ca", 69, "\"create_time\":\"2021-11-02 20:00:11\"", "2020-02-02 20:00:06+00:00"]]}
                ]
                }
            ],
            "expected_results": [{"query_id" : 701, "expected_results":
            [
                ["60", "2020-02-02 20:00:01+00:00", "2020-02-02 20:00:02+00:00", "341031629", "dev2"],
                ["68", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:03+00:00", "1500306067", "dev1"]
            ]}
            ]
        },
        {
            "id": 2,
            "tags": ["session window"],
            "name": "stream session window with datetime32",
            "description": "stream session window with interval triggered emit, 5s interval with session_size 25s",
            "steps":[
                {"statements": [
                    {"client":"python", "query_id": 701, "query_type": "stream", "terminate":"auto", "query_end_timer": 1, "query":"select max(value), window_start, window_end, __tp_session_id, id from session(test_session, to_start_of_interval(timestamp, 2s), 5s, id) group by __tp_session_id, window_start, window_end, id"}
                ]},
                {"inputs": [
                    {"table_name":"test_session","depends_on":"701", "data": [
                        ["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:00+00:00"],
                        ["dev2", "ca", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:01+00:00"]
                    ]},

                    {"table_name":"test_session","depends_on":"701", "data": [
                        ["dev1", "ca", 66, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:01+00:00"],
                        ["dev2", "ca", 60, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:02+00:00"]
                    ]},

                    {"table_name":"test_session", "data": [["dev2", "ca", 67, "\"create_time\":\"2021-11-02 20:00:11\"", "2020-02-02 20:00:08+00:00"]]}
                ]
                }
            ],
            "expected_results": [{"query_id" : 701, "expected_results":
            [
                ["60", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:02+00:00", "341031629", "dev2"]
            ]}
            ]
        },
        {
            "id": 3,
            "tags": ["session window"],
            "name": "stream session window with multiple session keys",
            "description": "stream session window with multiple session keys, triggered by interval, 2s interval with session_size 10",
            "steps":[
                {"statements": [
                    {"client":"python", "query_id": 701, "query_type": "stream", "terminate":"auto", "query_end_timer": 1, "query":"select max(value), window_start, window_end, __tp_session_id, id, location from session(test_session, timestamp, 2s, id, location) group by __tp_session_id, window_start, window_end, id, location"}
                ]},
                {"inputs": [
                    {"table_name":"test_session","depends_on":"701", "data": [
                        ["dev1", "ca", 57.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:00+00:00"],
                        ["dev2", "bj", 58.3, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:01+00:00"]
                    ]},

                    {"table_name":"test_session","depends_on":"701", "data": [
                        ["dev1", "ca", 66, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:02+00:00"],
                        ["dev2", "ca", 60, "\"create_time\":\"2021-11-02 20:00:00\"", "2020-02-02 20:00:02+00:00"]
                    ]},

                    {"table_name":"test_session", "data": [["dev3", "ca", 67, "\"create_time\":\"2021-11-02 20:00:11\"", "2020-02-02 20:00:15+00:00"]]}
                ]
                }
            ],
            "expected_results": [{"query_id" : 701, "expected_results":
            [
                ["66", "2020-02-02 20:00:00+00:00", "2020-02-02 20:00:02+00:00", "2746372735", "dev1", "ca"],
                ["60", "2020-02-02 20:00:02+00:00", "2020-02-02 20:00:02+00:00", "4072938192", "dev2", "ca"],
                ["58.3", "2020-02-02 20:00:01+00:00", "2020-02-02 20:00:01+00:00", "4269204367", "dev2", "bj"]
            ]}
            ]
        }
    ]
}
