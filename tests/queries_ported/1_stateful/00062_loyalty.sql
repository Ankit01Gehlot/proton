SELECT loyalty, count() AS c, log(c + 1) * 1000 FROM (SELECT UserID, to_int8((yandex > google ? yandex / (yandex + google) : -google / (yandex + google)) * 10) AS loyalty FROM (SELECT UserID, sum(to_uint8(SearchEngineID = 2)) AS yandex, sum(to_uint8(SearchEngineID = 3)) AS google from table(test.hits) WHERE SearchEngineID = 2 OR SearchEngineID = 3 GROUP BY UserID HAVING yandex + google > 10)) GROUP BY loyalty ORDER BY loyalty