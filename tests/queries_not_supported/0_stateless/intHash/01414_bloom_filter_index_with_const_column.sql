DROP STREAM IF EXISTS test_bloom_filter_index;

create stream test_bloom_filter_index(`WatchID` uint64, `JavaEnable` uint8, `Title` string, `GoodEvent` Int16, `EventTime` DateTime, `EventDate` date, `CounterID` uint32, `ClientIP` uint32, `ClientIP6` FixedString(16), `RegionID` uint32, `UserID` uint64, `CounterClass` int8, `OS` uint8, `UserAgent` uint8, `URL` string, `Referer` string, `URLDomain` string, `RefererDomain` string, `Refresh` uint8, `IsRobot` uint8, `RefererCategories` array(UInt16), `URLCategories` array(UInt16), `URLRegions` array(uint32), `RefererRegions` array(uint32), `ResolutionWidth` UInt16, `ResolutionHeight` UInt16, `ResolutionDepth` uint8, `FlashMajor` uint8, `FlashMinor` uint8, `FlashMinor2` string, `NetMajor` uint8, `NetMinor` uint8, `UserAgentMajor` UInt16, `UserAgentMinor` FixedString(2), `CookieEnable` uint8, `JavascriptEnable` uint8, `IsMobile` uint8, `MobilePhone` uint8, `MobilePhoneModel` string, `Params` string, `IPNetworkID` uint32, `TraficSourceID` int8, `SearchEngineID` UInt16, `SearchPhrase` string, `AdvEngineID` uint8, `IsArtifical` uint8, `WindowClientWidth` UInt16, `WindowClientHeight` UInt16, `ClientTimeZone` Int16, `ClientEventTime` DateTime, `SilverlightVersion1` uint8, `SilverlightVersion2` uint8, `SilverlightVersion3` uint32, `SilverlightVersion4` UInt16, `PageCharset` string, `CodeVersion` uint32, `IsLink` uint8, `IsDownload` uint8, `IsNotBounce` uint8, `FUniqID` uint64, `HID` uint32, `IsOldCounter` uint8, `IsEvent` uint8, `IsParameter` uint8, `DontCountHits` uint8, `WithHash` uint8, `HitColor` FixedString(1), `UTCEventTime` DateTime, `Age` uint8, `Sex` uint8, `Income` uint8, `Interests` UInt16, `Robotness` uint8, `GeneralInterests` array(UInt16), `RemoteIP` uint32, `RemoteIP6` FixedString(16), `WindowName` int32, `OpenerName` int32, `HistoryLength` Int16, `BrowserLanguage` FixedString(2), `BrowserCountry` FixedString(2), `SocialNetwork` string, `SocialAction` string, `HTTPError` UInt16, `SendTiming` int32, `DNSTiming` int32, `ConnectTiming` int32, `ResponseStartTiming` int32, `ResponseEndTiming` int32, `FetchTiming` int32, `RedirectTiming` int32, `DOMInteractiveTiming` int32, `DOMContentLoadedTiming` int32, `DOMCompleteTiming` int32, `LoadEventStartTiming` int32, `LoadEventEndTiming` int32, `NSToDOMContentLoadedTiming` int32, `FirstPaintTiming` int32, `RedirectCount` int8, `SocialSourceNetworkID` uint8, `SocialSourcePage` string, `ParamPrice` Int64, `ParamOrderID` string, `ParamCurrency` FixedString(3), `ParamCurrencyID` UInt16, `GoalsReached` array(uint32), `OpenstatServiceName` string, `OpenstatCampaignID` string, `OpenstatAdID` string, `OpenstatSourceID` string, `UTMSource` string, `UTMMedium` string, `UTMCampaign` string, `UTMContent` string, `UTMTerm` string, `FromTag` string, `HasGCLID` uint8, `RefererHash` uint64, `URLHash` uint64, `CLID` uint32, `YCLID` uint64, `ShareService` string, `ShareURL` string, `ShareTitle` string, `ParsedParams.Key1` array(string), `ParsedParams.Key2` array(string), `ParsedParams.Key3` array(string), `ParsedParams.Key4` array(string), `ParsedParams.Key5` array(string), `ParsedParams.ValueDouble` array(float64), `IslandID` FixedString(16), `RequestNum` uint32, `RequestTry` uint8, INDEX test1 RegionID TYPE bloom_filter GRANULARITY 8129) ENGINE = MergeTree() PARTITION BY toYYYYMM(EventDate) ORDER BY (CounterID, EventDate, intHash32(UserID)) SAMPLE BY intHash32(UserID) SETTINGS index_granularity = 8192;

SELECT UserID FROM test_bloom_filter_index WHERE (CounterID, EventTime) IN (SELECT to_uint32(25703952), to_datetime('2014-03-19 23:59:58'));

DROP STREAM IF EXISTS test_bloom_filter_index;

create stream test_bloom_filter_index(`uint8` uint8, `uint16` UInt16, `index_column` uint64,  INDEX test1 `index_column` TYPE bloom_filter GRANULARITY 1) ENGINE = MergeTree() PARTITION BY tuple() ORDER BY tuple();

INSERT INTO test_bloom_filter_index SELECT number, number, number FROM numbers(10000);

SELECT * FROM test_bloom_filter_index WHERE (`uint16`, `index_column`) IN (SELECT to_uint16(2), to_uint64(2));

DROP STREAM IF EXISTS test_bloom_filter_index;
